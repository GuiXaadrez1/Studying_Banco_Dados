# Introdu√ß√£o

O la√ßo de repeti√ß√£o FOR √© uma estrutura de controle de fluxo utilizada em linguagens de programa√ß√£o para executar repetidamente um bloco de instru√ß√µes dentro de um escopo delimitado. 

Diferente do WHILE, onde a quantidade de repeti√ß√µes √© determinada dinamicamente por uma condi√ß√£o l√≥gica avaliada a cada itera√ß√£o, o FOR se destaca por ser um loop de itera√ß√µes determin√≠sticas ‚Äî ou seja, o n√∫mero de vezes que as instru√ß√µes internas ser√£o executadas √© previamente conhecido ou definido por um intervalo.

No PostgreSQL, dentro do PL/pgSQL, o FOR √© uma das estruturas mais poderosas e vers√°teis, pois pode ser usado em diferentes contextos.

## Tipos de FOR

- **FOR num√©rico (cl√°ssico):** percorre um intervalo definido de valores inteiros, semelhante ao range() em Python.

Exemplo: 

```sql
FOR i IN 1..10 LOOP 
    ... 
END LOOP;
-- Executa exatamente 10 itera√ß√µes.
```

- **FOR num√©rico com incremento customizado (BY k):** permite modificar o passo de incremento, seja positivo ou negativo.

Exemplo: 

```sql 

FOR i IN 1..10 BY 2 LOOP 
    ... 
END LOOP;
-- Executa as itera√ß√µes de 2 em 2.
```
- **FOR reverso (REVERSE):** itera em ordem decrescente.

Exemplo: 

```sql
FOR i IN REVERSE 10..1 LOOP 
    ... 
END LOOP;

-- Executa da direita para a esquerda, decrementando.
```

- **FOR baseado em consultas (FOR ... IN SELECT):** 

utilizado para percorrer linha a linha o resultado de uma query. Nesse caso, cada itera√ß√£o retorna um RECORD ou uma vari√°vel estruturada. √â uma forma de cursor impl√≠cito.

Exemplo:
```sql
FOR rec IN SELECT id, nome FROM clientes LOOP
    -- manipula cada linha
END LOOP;
```

- **FOR EACH ROW (em TRIGGERS):** n√£o √© um loop cl√°ssico, mas uma cl√°usula que define que a fun√ß√£o de gatilho ser√° executada uma vez para cada linha afetada por uma opera√ß√£o DML (INSERT, UPDATE, DELETE).

Exemplo:

```sql
CREATE TRIGGER log_auditoria
AFTER UPDATE ON produtos
FOR EACH ROW -- depois de um update ser realizado o gatilho vai disparar para cada linha
EXECUTE FUNCTION registrar_log();
```

## Caracter√≠sticas Fudamentais

O la√ßo FOR em PL/pgSQL √© determin√≠stico quando usado na forma num√©rica: o n√∫mero de itera√ß√µes √© conhecido.

Ele √© vers√°til, pois pode operar tanto em intervalos num√©ricos quanto sobre o resultado de consultas SQL.

O controle do incremento (BY k) e da ordem de itera√ß√£o (REVERSE) fornece flexibilidade para cen√°rios variados.

√â uma estrutura impl√≠cita de cursor quando aplicada sobre queries, simplificando o tratamento de m√∫ltiplas linhas sem necessidade de abrir/fechar cursores manualmente.

No contexto de triggers, o FOR EACH ROW traz a sem√¢ntica de ‚Äúexecutar uma vez por tupla afetada‚Äù.

## Resumo Comparativo

| Estrutura           | Caracter√≠stica                                           | Uso Principal                          |
| ------------------- | -------------------------------------------------------- | -------------------------------------- |
| `WHILE`             | Condicional (repete enquanto a condi√ß√£o for verdadeira)  | Loops indeterminados                   |
| `LOOP`              | Loop gen√©rico (precisa de `EXIT` para parar)             | Estruturas personalizadas de repeti√ß√£o |
| `FOR` (num√©rico)    | Itera√ß√µes determin√≠sticas em intervalo conhecido         | Contadores e sequ√™ncias                |
| `FOR ... IN SELECT` | Itera√ß√£o linha a linha sobre um conjunto retornado       | Manipula√ß√£o de datasets                |
| `FOR EACH ROW`      | Disparado em triggers, executa por cada linha modificada | Auditoria e consist√™ncia               |

## Sintaxe B√°sica comentada
Em plpgsql a sintaxe segue da seguinte forma, vamos mostrar o FOR tradicional:

```sql
DO $$
DECLARE
    vari√°vel INTEGER;
BEGIN
    -- La√ßo de i at√© j (inclusive)
    FOR vari√°vel IN i..j LOOP
        -- instru√ß√µes/comandos...
    END LOOP;

    /*
        Funcionamento:
        - O la√ßo come√ßa no valor i
        - A cada itera√ß√£o, vari√°vel √© incrementada em 1
        - O bloco interno executa at√© vari√°vel atingir j
        - Portanto, o la√ßo √© executado (j - i + 1) vezes
    */
END;
$$ LANGUAGE plpgsql;
```

**Anal√≥gia com Python (fun√ß√£o range):**

```python
for i in range(0, 10, 2):  # in√≠cio=0, fim=10 (n√£o incluso), incremento=2
    print(i + 1)

'''SAIDA:
1
3
5
7
9
'''
```
‚û° Isso executa um la√ßo de 0 at√© 9, pulando de 2 em 2, e imprime i+1.

No PL/pgSQL o conceito √© o mesmo: IN i..j equivale ao range(inicio, fim+1) em Python.


### Resumindo tudo acima da minha forma
```sql
DO $$
    BEGIN
        FOR vari√°vel IN inicio..fim LOOP
            -- instru√ß√µes/comandos
        END LOOP;
    END;
$$ LANGUAGE plpgsql;
```

## VARIA√á√ïES DO FOR

aqui √© uma varia√ß√£o do for tradicional ao qual o la√ßo √© executado de k em k ap√≥s cada bloco ser executado, faz-se automaticamente i = i + k. Ou seja:

‚ûï Incremento customizado (BY k)

Podemos definir o passo (incremento) de cada itera√ß√£o:

```sql
DO $$
    DECLARE
        var INTEGER;
    BEGIN
        FOR var IN 1..10 BY 2 LOOP
            RAISE NOTICE 'Itera√ß√£o: %', var;
        END LOOP;
    END;
$$ LANGUAGE plpgsql;

/*SAIDA:

Itera√ß√£o: 1
Itera√ß√£o: 3
Itera√ß√£o: 5
Itera√ß√£o: 7
Itera√ß√£o: 9

*/
```

### FOR DECREMENTANDO OS VALORES

Caso queira percorrer o intervalo em ordem decrescente, usamos REVERSE. Ou seja, ao inv√©s de incrementa√ß√£o i++, fazemos o oposto: i--, para isso colocamos a palavra chave IN REVERSE

```sql
DO $$
    DECLARE
        var INTEGER;
    BEGIN
        FOR var IN REVERSE 10..1 LOOP
            RAISE NOTICE 'Itera√ß√£o: %', var;
        END LOOP;
    END;
$$ LANGUAGE plpgsql;

/*SAIDA:
Itera√ß√£o: 10
Itera√ß√£o: 9
Itera√ß√£o: 8
...
Itera√ß√£o: 1
*/
```

**Tamb√©m pode ser combinado com BY k para pular valores:**

```sql
DO$$
    DECLARE
    BEGIN
        FOR var IN REVERSE 10..1 BY 2 LOOP
            -- instru√ß√µes/comandos...;
        END FOR;
    END;
$$
Language plpgsql;
```

## FOR EACH/FOR EACH ROW

**Defini√ß√µes:** 

No PL/pgSQL, o FOR EACH n√£o existe isolado ‚Äî mas o conceito √© FOR com cursor iterando linha por linha.

No PostgreSQL, o FOR EACH ROW aparece na sintaxe de TRIGGERS, n√£o em loops.

No contexto de triggers, aparece o FOR EACH ROW, mas ele n√£o √© um la√ßo de repeti√ß√£o.
Ele significa: ‚Äúexecutar a trigger para cada linha afetada‚Äù.

### FOR EACH ROW ‚Üí Usado em TRIGGER

No CREATE TRIGGER, voc√™ indica FOR EACH ROW pra dizer:

    "Para cada linha afetada por este evento, dispare a fun√ß√£o de trigger".
Exemplo real:

```sql
CREATE TRIGGER trg_auditoria
    AFTER UPDATE ON produto
    FOR EACH ROW -- <- dispara para cada linha modificada
EXECUTE FUNCTION auditar_update();
```

Na fun√ß√£o RETURNS TRIGGER, voc√™ trata uma linha por vez:

```sql
CREATE OR REPLACE FUNCTION auditar_update() RETURNS TRIGGER 
AS $$
    BEGIN
        INSERT INTO log_produto (produto_id, data_modificacao)
        VALUES (NEW.id, now());
        RETURN NEW;
    END;
$$ 
LANGUAGE plpgsql;
```

## FOR ... IN SELECT (Percorrendo resultados)

Outra varia√ß√£o do FOR √© usada para percorrer o resultado de um SELECT dentro de uma fun√ß√£o ou bloco an√¥nimo:

```sql

DO $$
    DECLARE
        rec RECORD; -- RECORD √© o mesmo que %ROWTYPE
    BEGIN
        FOR rec IN
            SELECT id, nome FROM produto WHERE preco > 100
        LOOP
            RAISE NOTICE 'ID: %, Nome: %', rec.id, rec.nome;
        END LOOP;
    END;
$$ LANGUAGE plpgsql;

```
üìå Aqui o FOR cria automaticamente um cursor impl√≠cito para o SELECT.

‚öôÔ∏è Etapas explicadas:

- 1Ô∏è‚É£ DECLARE rec RECORD; ‚Üí cria uma vari√°vel do tipo RECORD.
- 2Ô∏è‚É£ FOR rec IN SELECT ... LOOP ‚Üí faz o cursor impl√≠cito.
- 3Ô∏è‚É£ Dentro do LOOP voc√™ manipula cada linha individualmente.
- 4Ô∏è‚É£ N√£o precisa abrir/fechar cursor manual ‚Äî o FOR ... IN SELECT faz isso automaticamente.

### Diferen√ßa fundamental

| Tipo           | Onde usado             | O que faz                                                                |
| -------------- | ---------------------- | ------------------------------------------------------------------------ |
| `FOR EACH ROW` | Apenas em **TRIGGERS** | Executa a trigger **uma vez por linha afetada**.                         |
| `FOR ... LOOP` | Dentro de **PL/pgSQL** | Itera sobre **intervalos num√©ricos** ou **resultados de consultas SQL**. |

## Exemplos pr√°ticos
Exemplo 1:

```sql
DO$$
BEGIN
    FOR counter IN 1..5 LOOP
        RAISE NOTICE 'Counter: %', counter;
        -- Raise notice √© um print, printr(), console.log()
        -- ele exibe um coment√°rio, texto na tela...
        -- o % em algumas libs de integra√ß√£o banco de dados e linguagem de programa√ß√£o
        -- chamamos de place holder que vai referenciar uma vari√°vel
        -- a ordem de importa na hora de referenciar esse place holder para uma vari√°vel
    END LOOP;
END;
$$
Language plpgsql;

/*
SAIDA:
NOTICE Counter: 1
NOTICE Counter: 2
NOTICE Counter: 3
NOTICE Counter: 4
NOTICE Counter: 5
*/
```

Exemplo 2:

```sql
DO$$
BEGIN
    FOR counter IN 1..6 BY 2 LOOP
        RAISE NOTICE 'Counter: %', counter;
        -- Ele ir√° exibir na tela a mensagem de duas em duas itera√ß√µes
    END LOOP;
END;
$$
Language plpgsql;

/*SAIDA:
NOTICE Counter: 1
NOTICE Counter: 3
NOTICE Counter: 5
*/
```

Exemplo 3, fatorial com FOR:

```sql
CREATE OR REPLACE FUNCTION for_fat(IN n_positivo INTEGER) RETURNS INTEGER
AS $$
    DECLARE
        fat INTEGER := 1  
        i INTEGER  := 2
    BEGIN
        IF n_positivo > 0 THEN 
            IF n_positivo < 2 THEN
                RETURN fat;
            ELSE
                FOR i IN 1..n_positivo LOOP
                    fat := fat * i
                END LOOP;
                RETURN fat;
        ELSE   
            RETURN -1;
        END IF;
    END;
$$
Language plpgsql;
```
