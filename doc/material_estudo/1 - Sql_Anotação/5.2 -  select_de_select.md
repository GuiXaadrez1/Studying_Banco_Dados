# Introdução Subqueries (SELECT dentro de SELECT)

Uma subquery é uma consulta SQL aninhada dentro de outra consulta. Também conhecida como **inner query ou nested SELECT**, a subquery permite que o resultado de uma consulta seja usado como entrada para outra consulta.

No PostgreSQL, subqueries podem ser aplicadas em:

- SELECT – para calcular valores derivados.

- FROM – como tabelas temporárias (inline views ou derived tables).

- WHERE – para filtrar registros com base em resultados de outra consulta.

- HAVING – para filtros em agregações condicionais.

As subqueries são poderosas para quebrar problemas complexos em etapas menores, aumentando clareza e modularidade da lógica.

## Estrutura Sintática

- Subquery em SELECT:

```sql
SELECT coluna1,
       (SELECT coluna2
        FROM tabela2
        WHERE tabela2.id = tabela1.id) AS alias -- nome da coluna que irá retornar os dados selecionados nesta subquery durante esse select
FROM tabela1; -- tabela que estamos referenciado para puxar os dados
```

- Subquery em FROM (tabela derivada):

```sql
-- selecionando as colunas, atributos referente a nossas tabela dericada (tabela retornada de uma subquery)
SELECT alias.coluna1, alias.total
FROM (
    SELECT coluna1, COUNT(*) AS total
    FROM tabela2
    GROUP BY coluna1
) AS alias; -- esse alias vamos usar para dar nome ao subquery que irá retornar uma tabela com registros com o dados retornados
```

- Subquery em WHERE:

```sql
SELECT coluna1
FROM tabela1
WHERE coluna2 IN (
    SELECT coluna2
    FROM tabela2
    WHERE condicao
); -- lembre-se que o in irá listar e checar todos os registros retornados da subquery e essa subquery terá que satisfazer a condição do WHERE no primeiro select
```

## Exemplos Práticos

- Exemplo 1 – Subquery em SELECT:

```sql
SELECT nome,
       (SELECT COUNT(*)
        FROM vendas v
        WHERE v.cliente_id = c.id_cliente) AS total_vendas
FROM clientes c;
```

Cada cliente terá uma coluna calculando o número total de vendas.

- Exemplo 2 – Subquery em FROM (tabela derivada):

```sql
SELECT cliente_id, total_vendas
FROM (
    SELECT cliente_id, COUNT(*) AS total_vendas
    FROM vendas
    GROUP BY cliente_id
) AS vendas_por_cliente
WHERE total_vendas > 10;
```

Primeiro, conta as vendas por cliente; depois, filtra apenas clientes com mais de 10 vendas.

- Exemplo 3 – Subquery em WHERE:

```sql
SELECT nome
FROM clientes
WHERE id_cliente IN (
    SELECT cliente_id
    FROM vendas
    GROUP BY cliente_id
    HAVING COUNT(*) > 10
);
```

Filtra clientes que realizaram mais de 10 compras, sem precisar criar CTEs.

## Tipos de Subqueries:

- Scalar Subquery:

Retorna um único valor.

Usada em SELECT, WHERE ou HAVING.

- Row Subquery:

Retorna uma única linha, mas múltiplas colunas.

Pode ser usada em comparações de tuplas:

    WHERE (col1, col2) = (SELECT col1, col2 FROM tabela2 WHERE id=1)

- Table Subquery:

Retorna múltiplas linhas e colunas.

Usada em FROM ou IN.

## Boas Práticas

Prefira CTEs (WITH) para subqueries complexas que precisam ser reutilizadas ou lidas facilmente.

Evite subqueries em colunas se a tabela for muito grande; isso pode gerar consulta lenta, pois o SELECT interno é executado para cada linha.

Utilize JOINs quando possível, pois podem ser mais eficientes que subqueries em WHERE ou SELECT.

Use aliases para claridade de colunas derivadas.

## Aplicações Reais

- Calcular agregações por grupo e usá-las em filtros.

- Obter estatísticas derivadas (média de vendas por cliente, total de pedidos por produto).

- Consultas de hierarquia ou relacionamentos complexos sem criar tabelas temporárias permanentes.

- Filtragem condicional baseada em resultados dinâmicos de outra tabela.